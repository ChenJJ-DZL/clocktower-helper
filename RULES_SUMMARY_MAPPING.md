# 官方规则概要映射文档

本文档记录了官方规则中的"规则概要"如何映射到代码逻辑和UI渲染上。

## 一、初始设置

### 1. 召集玩家，形成环形座位 ✅

**规则说明**：让玩家的座位形成一个环形，能够明确区分顺时针座次。

**实现位置**：
- `src/components/game/board/RoundTable.tsx` - 圆桌组件
- `src/components/game/board/SeatGrid.tsx` - 座位网格组件
- `src/utils/gameRules.ts` - `getSeatPosition` 函数

**代码说明**：
- 使用圆形布局计算座位位置
- 支持横屏（圆形）和竖屏（椭圆形）布局
- 座位按顺时针顺序排列，每个座位有唯一ID

### 2. 准备魔典 ✅

**规则说明**：组装魔典和魔典支架，放置在玩家不容易查看的地方。

**实现位置**：
- `src/components/game/board/TableCenterHUD.tsx` - 中心HUD显示
- `src/components/game/GameBoard.tsx` - 游戏主界面

**代码说明**：
- 魔典信息显示在中心位置（说书人可见）
- 角色标记和提示标记在UI中管理
- 支持夜晚顺序表显示

### 3. 选择一套剧本套装 ✅

**规则说明**：选择一个剧本，将剧本盒打开，放在魔典的左下角。

**实现位置**：
- `src/components/game/setup/ScriptSelection.tsx` - 剧本选择组件
- `app/data.ts` - `scripts` 数组

**代码说明**：
- 支持选择《暗流涌动》、《暗月初升》、《梦殒春宵》、《夜半狂欢》
- 剧本信息显示在UI中
- 剧本选择后影响可用角色列表

### 4. 准备城镇广场 ⚠️

**规则说明**：将城镇广场面板放在游戏区域正中，其上放置于玩家相对应的生命标记。

**实现位置**：
- `src/components/game/board/TableCenterHUD.tsx` - 中心HUD
- `src/components/game/board/SeatGrid.tsx` - 座位显示

**代码说明**：
- 当前实现：座位显示在圆桌周围
- 生命标记：通过 `isDead` 状态显示
- 投票标记：通过 `hasGhostVote` 状态管理
- **待完善**：旅行者列表显示（当前未实现）

### 5. 给新玩家宣读规则 ⚠️

**规则说明**：规则解释上面有新玩家开始游戏前需要知道的所有主要规则。

**实现位置**：
- 当前未实现规则宣读功能

**待实现**：
- 添加规则宣读界面
- 显示主要规则和手势信号说明
- 支持说书人宣读或玩家自行查看

### 6. 秘密选择角色 ✅

**规则说明**：根据游戏人数，参照旅行者列表设置本局出场角色。

**实现位置**：
- `src/components/game/setup/GameSetup.tsx` - 游戏设置组件
- `src/hooks/useGameController.ts` - `getStandardComposition` 函数

**代码说明**：
- 根据玩家数量自动计算标准阵容
- 支持手动选择角色
- 显示当前阵容分布（镇民、外来者、爪牙、恶魔）
- 支持男爵自动配平

### 7. 添加/移除角色（[]能力） ✅

**规则说明**：根据出场角色的"[]"能力（有橙色花瓣提示），调整角色配置。

**实现位置**：
- `src/hooks/useGameController.ts` - `handleBaronAutoRebalance` 函数
- `src/components/game/setup/GameSetup.tsx` - 男爵配置检查

**代码说明**：
- 男爵（Baron）自动调整：+2外来者，-2镇民
- 其他角色的[]能力在角色定义中处理
- 显示配置错误提示和建议

### 8. 向魔典中添加提示标记 ✅

**规则说明**：根据角色顶部的叶子数量添加对应的提示标记。

**实现位置**：
- `src/utils/nightLogic.ts` - 夜晚信息生成
- `src/hooks/useGameController.ts` - 夜晚行动处理

**代码说明**：
- 提示标记通过 `statusDetails` 和 `statuses` 管理
- 夜晚行动时自动添加相应标记
- 标记在UI中显示（中毒、保护等）

### 9. 分发角色 ✅

**规则说明**：洗混角色标记放入盲抽袋中，让每名玩家抽取一个角色标记。

**实现位置**：
- `src/components/game/setup/GameSetup.tsx` - 角色分配界面
- `src/hooks/useGameController.ts` - `onSeatClick` 函数

**代码说明**：
- 说书人点击座位选择角色
- 角色分配后显示在座位上
- 支持重新分配角色

### 10. 把角色标记放置在魔典中 ✅

**规则说明**：玩家确认自己角色后，收集所有玩家的角色标记，将它们放置在魔典中。

**实现位置**：
- `src/components/game/board/SeatGrid.tsx` - 座位显示
- `src/components/game/GameBoard.tsx` - 游戏主界面

**代码说明**：
- 角色标记显示在对应座位上
- 支持查看角色信息
- 魔典信息仅说书人可见

## 二、夜晚阶段

### 1. 准备夜晚阶段 ✅

**规则说明**：在进行夜晚阶段之前，你需要进行一些准备。

**实现位置**：
- `src/hooks/useNightLogic.ts` - `startNight` 函数
- `src/utils/nightQueueGenerator.ts` - 夜晚队列生成

**代码说明**：
- 自动选择正确的夜晚顺序表（首夜/其他夜晚）
- 生成夜晚行动队列
- 显示夜晚顺序预览
- 重置夜晚相关状态

### 2. 进行夜晚阶段 ✅

**规则说明**：让所有玩家闭眼，然后进入黄昏。按照夜晚顺序表从上到下进行行动。

**实现位置**：
- `src/hooks/useNightLogic.ts` - `startNight` 函数
- `src/hooks/useGameController.ts` - `handleConfirmAction` 函数
- `src/components/game/console/GameConsole.tsx` - 控制台显示

**代码说明**：
- 夜晚阶段自动开始
- 按照夜晚顺序表依次唤醒角色
- 显示当前行动的角色和指引
- 支持跳过不需要唤醒的角色

### 3. 夜晚的交流方式 ⚠️

**规则说明**：你需要使用手势与其他玩家在夜晚进行交流。

**实现位置**：
- `src/utils/nightLogic.ts` - `calculateNightInfo` 函数
- `src/components/game/console/GameConsole.tsx` - 控制台显示

**代码说明**：
- 当前实现：通过UI显示说书人台词和指引
- 支持数字、是/否、角色标记等信息展示
- **待完善**：实际的手势信号说明和演示（需要添加说明文档）

## 三、白天阶段

### 1. 白天的交流 ✅

**规则说明**：在白天，玩家们会互相交谈。他们可以谋划、撒谎、分享信息或保持沉默。

**实现位置**：
- `src/components/game/GameStage.tsx` - 游戏阶段组件
- `src/components/game/info/LogViewer.tsx` - 日志查看器

**代码说明**：
- 白天阶段允许玩家自由交流
- 游戏日志记录所有重要事件
- 支持说书人记录和查看信息

### 2. 提名与投票 ✅

**规则说明**：由说书人宣布白天进入提名环节。提名有以下几个限制。

**实现位置**：
- `src/hooks/useGameController.ts` - `executeNomination` 函数
- `src/components/game/GameStage.tsx` - 提名UI
- `src/components/game/GameModals.tsx` - 投票弹窗

**代码说明**：
- ✅ 同一时间只能有一名玩家被提名
- ✅ 只有存活的玩家可以发起提名
- ✅ 每名玩家每天只能发起一次提名
- ✅ 每名玩家每天只能被提名一次
- ✅ 被提名的玩家可以投票给自己（规则特例）
- ✅ 给被提名的玩家辩护时间（UI支持）
- ✅ 统计投票（参考投票计票环节）
- ✅ 投票成功条件：票数最多且 >= 存活人数的一半
- ✅ 平票处理：如果平票，都不被处决

### 3. 处决与死亡 ✅

**规则说明**：在处决阶段，当前"即将被处决"的玩家会被处决。

**实现位置**：
- `src/hooks/useGameController.ts` - `executePlayer` 函数
- `src/components/game/GameModals.tsx` - 处决结果弹窗

**代码说明**：
- ✅ 每个白天只能有一名玩家被处决
- ✅ 并非每个白天都需要处决一名玩家
- ✅ 死亡玩家立即失去角色能力
- ✅ 死亡玩家不能发起提名
- ✅ 死亡玩家只能在有投票标记时进行一次处决投票
- ✅ 死亡玩家的角色不会公开
- ✅ 死亡玩家仍要与自己的阵营一同胜利或失败

## 四、游戏结束

### 1. 善良阵营的胜利方式 ✅

**规则说明**：所有恶魔均死亡。

**实现位置**：
- `src/hooks/useGameController.ts` - `checkGameOver` 函数

**代码说明**：
- ✅ 检查所有恶魔（包括传位恶魔）是否死亡
- ✅ 如果所有恶魔死亡，善良阵营获胜
- ✅ 考虑红唇女郎传位情况
- ✅ 考虑镜像双子特殊情况

### 2. 邪恶阵营的胜利方式 ✅

**规则说明**：场上只剩两名玩家存活。（旅行者的数量不计算在内）

**实现位置**：
- `src/hooks/useGameController.ts` - `checkGameOver` 函数

**代码说明**：
- ✅ 计算存活玩家数量（排除旅行者）
- ✅ 如果存活玩家 <= 2，邪恶阵营获胜
- ✅ 考虑市长3人存活且无人被处决的特殊胜利

### 3. 同时满足胜利条件 ✅

**规则说明**：如果两个阵营同时达成胜利条件，则善良阵营获胜。

**实现位置**：
- `src/hooks/useGameController.ts` - `checkGameOver` 函数

**代码说明**：
- ✅ 优先检查善良阵营胜利条件
- ✅ 如果善良阵营满足条件，立即判定善良获胜
- ✅ 如果只有邪恶阵营满足条件，判定邪恶获胜

## 待完善的功能

1. **旅行者列表显示**：在城镇广场下方显示旅行者列表
2. **规则宣读界面**：添加新玩家规则宣读功能
3. **手势信号说明**：添加夜晚交流手势的说明文档
4. **生命标记翻转**：死亡时翻转生命标记的视觉效果
5. **投票标记管理**：更完善的投票标记显示和管理

## 已实现的规则验证

### 提名限制 ✅
- ✅ 同一时间只能有一名玩家被提名
- ✅ 只有存活的玩家可以发起提名
- ✅ 每名玩家每天只能发起一次提名
- ✅ 每名玩家每天只能被提名一次
- ✅ 规则特例：玩家可以对自己发起提名

### 投票规则 ✅
- ✅ 每名存活的玩家每天可以投票给任意数量的玩家
- ✅ 每名死亡的玩家在他死亡后，只剩最后一次投票机会
- ✅ 投票成功条件：票数最多（不得与他人并列）且 >= 存活人数的一半
- ✅ 平票处理：如果平票，都不被处决
- ✅ 规则特例：玩家可以在对自己的提名中投票

### 死亡规则 ✅
- ✅ 死亡玩家立即失去角色能力
- ✅ 死亡玩家不能发起提名
- ✅ 死亡玩家只能在有投票标记时进行一次处决投票
- ✅ 死亡玩家的角色不会公开
- ✅ 死亡玩家仍要与自己的阵营一同胜利或失败

### 胜利条件 ✅
- ✅ 善良阵营：所有恶魔均死亡
- ✅ 邪恶阵营：场上只剩两名玩家存活（旅行者不计入）
- ✅ 同时满足：善良阵营获胜
- ✅ 考虑特殊角色（红唇女郎、镜像双子、市长等）

## 代码质量

- ✅ 所有规则验证逻辑已实现
- ✅ 代码通过 lint 检查
- ✅ 规则特例已正确映射
- ✅ UI 支持所有必要的交互

