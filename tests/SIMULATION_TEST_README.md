# 完整游戏模拟测试系统使用说明

## 概述

这个测试系统用于运行100次9-15人随机对局的模拟游戏，生成详细的行动日志，帮助快速发现BUG和完善游戏逻辑。

## 功能特性

### 1. 详细日志记录
- **开局角色座位**：记录每个座位的角色分配
- **每个阶段的行动顺序和内容**：记录所有角色的行动
- **每个阶段所有角色的状态**：记录死亡、中毒、醉酒、保护等状态
- **控制台提示内容**：记录每次行动时给说书人的提示
- **弹窗信息**：记录每个阶段是否有弹窗以及弹窗内容
- **行动结果**：记录每个行动产生的结果或影响

### 2. 积极但随意的技能使用
- 所有玩家都会积极使用技能
- 目标选择是随机的，尽可能展示更多随机技能搭配
- 尽可能触发更多信息获取效果

### 3. 输出格式
- 控制台输出每局游戏的摘要
- 生成详细的日志文件到 `tests/simulation_logs/` 目录
- 生成汇总报告

## 使用方法

### 方法1：使用Node直接运行（推荐）

```bash
node tests/comprehensive_simulation_test.js
```

### 方法2：使用Jest运行

```bash
npm test -- tests/comprehensive_simulation_test.js
```

### 方法3：使用ts-node运行（如果安装了ts-node）

```bash
npx ts-node tests/comprehensive_simulation_test.js
```

## 输出文件

### 日志文件位置
所有详细日志保存在：`tests/simulation_logs/`

### 文件命名格式
- 单局日志：`game_001_good_12players.log`
- 汇总报告：`summary.txt`

### 日志文件内容结构

每个日志文件包含以下部分：

1. **开局信息**
   - 玩家数量
   - 阵容配置
   - 角色座位分配

2. **阶段行动记录**
   - 每个阶段的行动顺序
   - 每个行动的执行者、目标、结果
   - 说书人提示

3. **状态快照**
   - 每个重要时刻的完整状态
   - 所有玩家的状态（死亡、中毒、醉酒等）

4. **弹窗记录**
   - 所有弹窗的类型、时机、内容

5. **游戏结果**
   - 胜者
   - 总回合数

6. **完整日志**
   - 所有操作的详细记录

## 配置选项

可以在 `comprehensive_simulation_test.js` 文件中修改以下配置：

- **测试次数**：默认100次，修改 `main()` 函数中的循环次数
- **玩家数量范围**：默认9-15人，修改 `simulateGame()` 中的 `randomInt(9, 15)`
- **最大回合数**：默认50回合，修改 `simulateGame()` 的参数

## 示例输出

### 控制台输出
```
开始运行100次游戏模拟测试...

游戏 #1: 12人, 3天/3夜, 胜者: good, 耗时: 0.15s
游戏 #2: 10人, 4天/4夜, 胜者: evil, 耗时: 0.12s
...

进度: 10/100 (1.5s)

...

游戏模拟测试汇总报告
总测试次数: 100
总耗时: 15.23秒

胜负统计:
  good: 45次 (45.0%)
  evil: 55次 (55.0%)

玩家数量分布:
  9人: 12次
  10人: 15次
  ...
```

### 日志文件示例
```
================================================================================
游戏 #1 - 详细行动日志
================================================================================

## 开局信息
- 玩家数量: 12
- 阵容配置: {"total":12,"townsfolk":7,"outsider":2,"minion":2,"demon":1}
- 角色座位分配:
  1号座位: 占卜师 (townsfolk)
  2号座位: 投毒者 (minion)
  ...

## 阶段行动记录
### firstNight - 第1天/第1夜

#### 行动顺序:
1. 1号-占卜师 - 查验
   目标: 3号-僧侣、5号-恶魔
   结果: 其中至少一人是邪恶：是

#### 说书人提示:
- 夜晚选人指向含糊时，走到目标旁竖直指向头顶，双方点头确认，避免误会。
- 夜晚刻意多走动、不要只去固定角落，让脚步声难以被猜出是谁被叫醒。

...
```

## 注意事项

1. **运行时间**：100次模拟可能需要几分钟时间，请耐心等待
2. **日志文件大小**：每次模拟会生成较大的日志文件，确保有足够的磁盘空间
3. **内存使用**：如果遇到内存问题，可以减少测试次数或分批运行

## 故障排除

### 问题：无法导入 data.ts
**解决方案**：确保使用支持TypeScript的环境（如ts-jest或ts-node）

### 问题：日志目录不存在
**解决方案**：脚本会自动创建目录，如果失败请手动创建 `tests/simulation_logs/`

### 问题：运行速度慢
**解决方案**：
- 减少测试次数
- 减少最大回合数
- 关闭详细日志记录（修改代码）

## 扩展功能

### 添加更多角色技能
在 `simulateNight()` 和 `simulateDay()` 函数中添加更多角色的技能逻辑

### 自定义技能使用策略
修改随机选择逻辑，实现更智能的技能使用策略

### 添加更多统计信息
在汇总报告中添加更多统计数据，如：
- 各角色的胜率
- 平均存活时间
- 技能使用频率

## 贡献

如果发现BUG或想要改进测试系统，请：
1. 记录发现的问题
2. 提供复现步骤
3. 提交改进建议

